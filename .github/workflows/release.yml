name: Release
permissions:
    "contents": "write"

on:
    workflow_dispatch:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+"

jobs:
    # Rust binary release jobs
    build:
        uses: ./.github/workflows/build.yml
        with:
            run-test: false

    release:
        name: Release Rust Binaries on GitHub
        runs-on: ubuntu-latest
        needs: build
        permissions:
            id-token: write
            attestations: write
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Download build artifacts
              uses: actions/download-artifact@v7
              with:
                  path: artifacts

            - name: Display structure of downloaded files
              run: ls -lR
              working-directory: artifacts

            - name: Prepare release artifacts
              run: |
                  mkdir -p target
                  for platform in $(cd artifacts; ls | sed 's/^beancount-language-server\.//'); do
                    exe=$(ls artifacts/beancount-language-server.$platform/beancount-language-server*)
                    gzip --stdout --name $exe > target/beancount-language-server-$platform.gz
                    sha256sum target/beancount-language-server-$platform.gz | awk '{print $1}' > target/beancount-language-server-$platform.gz.sha256
                    if echo "$platform" | grep -q windows; then
                      zip -j target/beancount-language-server-$platform.zip "$exe"
                      sha256sum target/beancount-language-server-$platform.zip | awk '{print $1}' > target/beancount-language-server-$platform.zip.sha256
                    fi
                  done
                  rm -rf artifacts
                  ls -l target/

            - name: Generate attestations
              uses: actions/attest-build-provenance@v4
              with:
                  subject-path: |
                      target/beancount-language-server-*.gz
                      target/beancount-language-server-*.gz.sha256

            - name: Create release
              run: |-
                  gh release create $GITHUB_REF_NAME \
                  target/beancount-language-server-*.gz \
                  target/beancount-language-server-*.gz.sha256 \
                  target/beancount-language-server-*.zip \
                  target/beancount-language-server-*.zip.sha256 \
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    crates_io:
        name: Publish packages to Crates.io
        runs-on: ubuntu-latest
        environment: crates
        permissions:
            id-token: write
            contents: read
        needs: release
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Set up Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1

            - name: Set up registry token
              id: auth
              uses: rust-lang/crates-io-auth-action@v1

            - name: Publish crates to Crates.io
              uses: katyo/publish-crates@v2
              with:
                  registry-token: ${{ steps.auth.outputs.token }}

    # VSCode extension release job
    publish-vscode:
        name: Publish VS Code Extensions
        runs-on: ubuntu-latest
        needs: release
        defaults:
            run:
                working-directory: vscode
        steps:
            - name: Setup | Checkout
              uses: actions/checkout@v6

            - name: Setup | pnpm
              uses: pnpm/action-setup@v4
              with:
                  package_json_file: ./vscode/package.json

            - name: Setup | Node
              uses: actions/setup-node@v6
              with:
                  node-version: "22"
                  cache: pnpm
                  cache-dependency-path: vscode/pnpm-lock.yaml

            - name: Setup | Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.x"

            - name: Install Python deps
              run: python -m pip install --upgrade pip requests

            - name: Read version from package.json
              id: version
              run: |
                  PKG_VERSION=$(jq -r '.version' package.json)
                  echo "pkg_version=$PKG_VERSION" >> "$GITHUB_OUTPUT"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Package all targets
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: pnpm run package:all

            - name: Publish all VSIX to Marketplace
              env:
                  VSCE_PAT: ${{ secrets.VSCE_TOKEN }}
              run: |
                  set -euo pipefail
                  for f in dist/*.vsix; do
                    echo "Publishing $f"
                    pnpm exec vsce publish --no-dependencies --packagePath "$f" --pat "$VSCE_PAT"
                  done

            - name: Upload packaged extension
              uses: actions/upload-artifact@v4
              with:
                  name: beancount-language-server-vscode-${{ steps.version.outputs.pkg_version }}
                  path: vscode/dist/*.vsix
